## 程序代码

```c++
#include <stdio.h>
  
void func()  
{  
    char *p = NULL;  
    *p = 3;  
}  
  
int main()
{  
    func();

    return 0;  
}  
```

## debug 版调试

执行 `gcc -g -o segment segment.c` 编译，并运行 `./segment`，报错段错误。

```shell
ulimit -a  
core file size          (blocks, -c) 0  
```

core 文件大小限制为 0，不能生成 core 文件。可以使用如下命令取消限制，使系统能生成 core 文件，

```shell
ulimit -c unlimited

# 或者指定 core 文件大小，如 1K
ulimit -c 1024
```

上面这个方法在系统重启后会消失，永久生效的方法是：打开 /etc/security/limits.conf 文件，

```
*     soft  core unlimited
*     hard  core unlimited
```

再次执行程序就在程序当前目录下生成了 core 文件。

```shell
# gdb ./segment core  
GNU gdb (GDB) 7.1-ubuntu  
Copyright (C) 2010 Free Software Foundation, Inc.  
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>  
This is free software: you are free to change and redistribute it.  
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"  
and "show warranty" for details.  
This GDB was configured as "i486-linux-gnu".  
For bug reporting instructions, please see:  
<http://www.gnu.org/software/gdb/bugs/>...  
Reading symbols from /home/duanbb/test/segment/segment...done.  
[New Thread 3655]  
  
warning: Can't read pathname for load map: Input/output error.  
Reading symbols from /lib/tls/i686/cmov/libc.so.6...Reading symbols from /usr/lib/debug/lib/tls/i686/cmov/libc-2.11.1.so...done.  
done.  
Loaded symbols for /lib/tls/i686/cmov/libc.so.6  
Reading symbols from /lib/ld-linux.so.2...Reading symbols from /usr/lib/debug/lib/ld-2.11.1.so...done.  
done.  
Loaded symbols for /lib/ld-linux.so.2  
Core was generated by `./segment'.  
Program terminated with signal 11, Segmentation fault.  
#0  0x080483c4 in func () at segment.c:10  
10    *p = 3;  
```

可以清楚地看到，程序在第 10 行代码， func() 函数内，执行 `*p = 3` 时发生了 segment 错误。

另外，输入 `bt` 可以查看整个调用树。

## release 版调试

众所周知，发布程序时必须是 release 版的，杜绝 debug 版。下面就来看看如何调试 release 版程序生成的 core 文件。

还是如上程序，编译 release 版：`gcc -o segment segment.c`  

运行程序：

```shell
./segment  
Segmentation fault (core dumped)  
```

调试，

```shell
$ gdb ./segment core   
GNU gdb (GDB) 7.1-ubuntu  
Copyright (C) 2010 Free Software Foundation, Inc.  
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>  
This is free software: you are free to change and redistribute it.  
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"  
and "show warranty" for details.  
This GDB was configured as "i486-linux-gnu".  
For bug reporting instructions, please see:  
<http://www.gnu.org/software/gdb/bugs/>...  
Reading symbols from /home/duanbb/test/segment/segment...(no debugging symbols found)...done.  
[New Thread 4711]  
  
warning: Can't read pathname for load map: Input/output error.  
Reading symbols from /lib/tls/i686/cmov/libc.so.6...Reading symbols from /usr/lib/debug/lib/tls/i686/cmov/libc-2.11.1.so...done.  
done.  
Loaded symbols for /lib/tls/i686/cmov/libc.so.6  
Reading symbols from /lib/ld-linux.so.2...Reading symbols from /usr/lib/debug/lib/ld-2.11.1.so...done.  
done.  
Loaded symbols for /lib/ld-linux.so.2  
Core was generated by `./segment'.  
Program terminated with signal 11, Segmentation fault.  
#0  0x080483c4 in func ()  
(gdb)   
```

只能显示出出错时的函数，而看不到出错的具体位置，怎么办？

方法： **用发布时的原代码，在原有的编译选项上（不要改变任何编译参数，即使有`-O2`参数，也不要动），只加上 `-g` 选项，编译出对应的 debug 程序。**

```shell
# gcc -g -o segment_d segment.c  
```

```shell
# gdb ./segment_d core  
GNU gdb (GDB) 7.1-ubuntu  
Copyright (C) 2010 Free Software Foundation, Inc.  
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>  
This is free software: you are free to change and redistribute it.  
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"  
and "show warranty" for details.  
This GDB was configured as "i486-linux-gnu".  
For bug reporting instructions, please see:  
<http://www.gnu.org/software/gdb/bugs/>...  
Reading symbols from /home/duanbb/test/segment/segment_d...done.  
  
warning: core file may not match specified executable file.  
[New Thread 4711]  
  
warning: Can't read pathname for load map: Input/output error.  
Reading symbols from /lib/tls/i686/cmov/libc.so.6...Reading symbols from /usr/lib/debug/lib/tls/i686/cmov/libc-2.11.1.so...done.  
done.  
Loaded symbols for /lib/tls/i686/cmov/libc.so.6  
Reading symbols from /lib/ld-linux.so.2...Reading symbols from /usr/lib/debug/lib/ld-2.11.1.so...done.  
done.  
Loaded symbols for /lib/ld-linux.so.2  
Core was generated by `./segment'.  
Program terminated with signal 11, Segmentation fault.  
#0  0x080483c4 in func () at segment.c:10  
10    *p = 3;  
```

即可定位出错误位置。

## 参考

- <https://blog.csdn.net/zxh2075/article/details/76849332>

